pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: nodeserver
spec:
  containers:
  - name: nodeserver
    image: bjake1878/nodejs-app-dev:latest
    command:
    - cat
    tty: true
        '''
            retries 2
        }
    }
    stages {
        stage('Clone github repo') {
            steps {
                container('nodeserver') {
                    echo 'Retrieving latest release...'
                    sh 'git clone https://github.com/bjake1878/jenkins-dev.git'
                }
            }
        }
        stage('Installing jasmine') {
            steps {
                container('nodeserver') {
                    echo 'Installing jasmine...'
                    sh 'cd jenkins-dev && npm install --save-dev jasmine'
                }
            }
        }
        stage('Testing nodejs with jasmine') {
            steps {
                container('nodeserver') {
                    echo 'Testing node js application....'
                    sh 'cd jenkins-dev && npm test'
                }
            }
        }
    }
}
